<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Tutor - Exercise Platform</title>
    <base href="./">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .content { padding: 30px; }
        .exercise-selector { margin-bottom: 30px; }
        .exercise-selector select { width: 100%; padding: 15px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; cursor: pointer; }
        .exercise-selector select:focus { outline: none; border-color: #667eea; }
        .exercise-section { display: none; }
        .exercise-section.active { display: block; }
        .question-box { background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 25px; border-left: 5px solid #667eea; }
        .question-box h2 { color: #333; margin-bottom: 15px; font-size: 1.5em; }
        .question-box p { color: #555; line-height: 1.6; font-size: 1.1em; }
        .materials-box { background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 25px; }
        .materials-box h3 { color: #1976d2; margin-bottom: 15px; }
        .materials-box ul { list-style: none; padding-left: 0; }
        .materials-box li { padding: 10px; margin-bottom: 10px; background: white; border-radius: 5px; border-left: 3px solid #1976d2; }
        .materials-box a { color: #1976d2; text-decoration: none; font-weight: 500; }
        .materials-box a:hover { text-decoration: underline; }
        .answer-section { margin-bottom: 25px; }
        .answer-section label { display: block; font-weight: 600; margin-bottom: 10px; color: #333; font-size: 1.1em; }
        .answer-section .editor-wrap { width: 100%; min-height: 220px; border: 2px solid #e0e0e0; border-radius: 8px; overflow: hidden; }
        .answer-section .editor-wrap:focus-within { border-color: #667eea; }
        #codeEditor { width: 100%; min-height: 220px; font-size: 14px; }
        .console-output { margin-top: 15px; padding: 15px; background: #1e1e1e; color: #d4d4d4; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-break: break-all; min-height: 80px; max-height: 200px; overflow-y: auto; }
        .console-output.empty { color: #888; }
        .console-output .stderr { color: #f48771; }
        .button-group { display: flex; gap: 15px; margin-bottom: 25px; }
        button { padding: 15px 30px; font-size: 16px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        .btn-submit { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; flex: 1; }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-run { background: #2e7d32; color: white; }
        .btn-run:hover { background: #1b5e20; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(46, 125, 50, 0.4); }
        .btn-run:disabled, .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .result-box { display: none; padding: 25px; border-radius: 10px; margin-top: 25px; }
        .result-box.show { display: block; }
        .result-box.passed { background: #e8f5e9; border-left: 5px solid #4caf50; }
        .result-box.failed { background: #ffebee; border-left: 5px solid #f44336; }
        .result-box h3 { margin-bottom: 15px; font-size: 1.5em; }
        .result-box.passed h3 { color: #2e7d32; }
        .result-box.failed h3 { color: #c62828; }
        .score { font-size: 2em; font-weight: bold; margin: 15px 0; }
        .result-box.passed .score { color: #4caf50; }
        .result-box.failed .score { color: #f44336; }
        .feedback { margin-top: 15px; line-height: 1.6; color: #333; }
        .suggestions { margin-top: 15px; padding: 15px; background: white; border-radius: 5px; border-left: 3px solid #ff9800; }
        .suggestions h4 { color: #f57c00; margin-bottom: 10px; }
        .loading { display: none; text-align: center; padding: 20px; }
        .loading.show { display: block; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-python.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/theme-chrome.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ext-language_tools.js" charset="utf-8"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        .auth-box { background: #f0f4ff; padding: 16px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #667eea; }
        .auth-box h3 { font-size: 1em; margin-bottom: 10px; color: #333; }
        .auth-box label { display: inline-block; width: 100px; font-weight: 600; }
        .auth-box input { padding: 8px 12px; margin: 4px 8px 4px 0; border-radius: 6px; border: 1px solid #ccc; width: 200px; }
        .auth-box input[type="password"] { width: 180px; }
        .auth-box .row { margin-bottom: 8px; }
        .auth-box .hint { font-size: 0.85em; color: #666; margin-top: 8px; }
        .auth-box a { color: #1976d2; margin-left: 8px; }
        .auth-divider { color: #666; font-size: 0.9em; margin: 8px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêç Python Tutor</h1>
            <p>Learn Python Programming - Complete Exercises and Get AI Feedback (Groq)</p>
        </div>
        <div class="content">
            <div class="auth-box">
                <h3>üîë To get your answers graded, choose one:</h3>
                <div class="row">
                    <label>Your API key</label>
                    <input type="password" id="apiKey" placeholder="Paste your Groq API key (gsk_‚Ä¶)" autocomplete="off" />
                    <a href="https://console.groq.com/keys" target="_blank" rel="noopener">Get a free API key ‚Üí</a>
                </div>
                <div class="row auth-divider">‚Äî or log in to use the teacher‚Äôs API ‚Äî</div>
                <div class="row">
                    <label>Username</label>
                    <input type="text" id="authUser" placeholder="Username" autocomplete="username" />
                    <label>Password</label>
                    <input type="password" id="authPass" placeholder="Password" autocomplete="current-password" />
                </div>
                <div class="hint">Saved in this browser only. You only need either an API key or login.</div>
            </div>
            <div class="exercise-selector">
                <select id="exerciseSelect">
                    <option value="">Select an exercise...</option>
                </select>
            </div>
            <div id="exerciseContainer" class="exercise-section">
                <div class="question-box">
                    <h2>Question</h2>
                    <p id="questionText"></p>
                </div>
                <div class="materials-box">
                    <h3>üìö Learning Materials</h3>
                    <ul id="materialsList"></ul>
                </div>
                <div class="answer-section">
                    <label>Your Answer:</label>
                    <div class="editor-wrap">
                        <div id="codeEditor"></div>
                    </div>
                    <div class="console-output empty" id="consoleOutput">Console output will appear here after you run your code.</div>
                </div>
                <div class="button-group">
                    <button type="button" class="btn-run" id="runBtn" onclick="runCode()">‚ñ∂ Run Code</button>
                    <button class="btn-submit" id="submitBtn" onclick="submitAnswer()">Submit Answer</button>
                </div>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px;">Grading your answer...</p>
                </div>
                <div class="result-box" id="resultBox">
                    <h3 id="resultTitle"></h3>
                    <div class="score" id="score"></div>
                    <div class="feedback" id="feedback"></div>
                    <div class="suggestions" id="suggestions"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Set this to your backend URL when you deploy (e.g. Render). Same repo can host backend from GitHub.
        const BACKEND_URL = '';  // e.g. 'https://python-tutor-xxx.onrender.com'

        let currentExerciseId = null;
        let currentExercise = null;
        let exercises = [];
        let codeEditor = null;
        let pyodideReady = null;

        const STORAGE_KEY = 'python_tutor_auth';
        function loadAuth() {
            try {
                const s = sessionStorage.getItem(STORAGE_KEY);
                if (s) {
                    const o = JSON.parse(s);
                    if (o.apiKey) document.getElementById('apiKey').value = o.apiKey;
                    if (o.username) document.getElementById('authUser').value = o.username;
                    if (o.password) document.getElementById('authPass').value = o.password;
                }
            } catch (e) {}
        }
        function saveAuth() {
            const o = {
                apiKey: document.getElementById('apiKey').value,
                username: document.getElementById('authUser').value,
                password: document.getElementById('authPass').value
            };
            sessionStorage.setItem(STORAGE_KEY, JSON.stringify(o));
        }
        document.addEventListener('DOMContentLoaded', loadAuth);
        ['apiKey','authUser','authPass'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', saveAuth);
        });

        function getBase() {
            const p = window.location.pathname;
            if (p.endsWith('/')) return p;
            if (p.endsWith('index.html')) return p.replace(/index\.html$/, '');
            return p.replace(/\/[^/]*$/, '/') || '/';
        }

        function getEditorContent() { return codeEditor ? codeEditor.getValue() : ''; }
        function setEditorContent(value) { if (codeEditor) codeEditor.setValue(value || '', -1); }

        function initEditor() {
            const el = document.getElementById('codeEditor');
            if (!el || codeEditor) return;
            codeEditor = ace.edit('codeEditor');
            codeEditor.setTheme('ace/theme/chrome');
            codeEditor.session.setMode('ace/mode/python');
            codeEditor.setOptions({ fontSize: '14px', showPrintMargin: false, highlightActiveLine: true, enableBasicAutocompletion: true, enableSnippets: true, enableLiveAutocompletion: true, tabSize: 4, useSoftTabs: true });
            codeEditor.session.setValue('# Write your Python code here\n', -1);
        }

        async function loadPyodide() {
            if (pyodideReady) return pyodideReady;
            pyodideReady = loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/' });
            await pyodideReady;
            return pyodideReady;
        }

        async function runCode() {
            const code = getEditorContent().trim();
            if (!code) { updateConsole('', 'No code to run.', false); return; }
            const runBtn = document.getElementById('runBtn');
            const outEl = document.getElementById('consoleOutput');
            runBtn.disabled = true;
            outEl.classList.remove('empty');
            outEl.textContent = 'Loading Python...';
            let stdout = '', stderr = '';
            try {
                const pyodide = await loadPyodide();
                outEl.textContent = 'Running...';
                const chunks = [];
                pyodide.setStdout({ write: (msg) => chunks.push(msg) });
                pyodide.setStderr({ write: (msg) => chunks.push(msg) });
                await pyodide.runPythonAsync(code);
                stdout = chunks.join('');
                updateConsole(stdout, '', true);
            } catch (err) {
                stderr = err.message || String(err);
                updateConsole('', stderr, false);
            } finally {
                runBtn.disabled = false;
            }
        }

        function updateConsole(stdout, stderr, success) {
            const el = document.getElementById('consoleOutput');
            el.classList.remove('empty');
            el.innerHTML = '';
            if (stdout) { const pre = document.createElement('pre'); pre.textContent = stdout; el.appendChild(pre); }
            if (stderr) { const pre = document.createElement('pre'); pre.className = 'stderr'; pre.textContent = stderr; el.appendChild(pre); }
            if (!stdout && !stderr) el.textContent = success ? '(no output)' : 'Error';
        }

        async function loadExercises() {
            try {
                const base = getBase();
                const response = await fetch(base + 'exercises/manifest.json');
                exercises = await response.json();
                const select = document.getElementById('exerciseSelect');
                select.innerHTML = '<option value="">Select an exercise...</option>';
                exercises.forEach(ex => {
                    const opt = document.createElement('option');
                    opt.value = ex.id;
                    opt.textContent = ex.title;
                    select.appendChild(opt);
                });
            } catch (e) { console.error('Error loading exercises:', e); }
        }

        document.getElementById('exerciseSelect').addEventListener('change', async function(e) {
            const exerciseId = e.target.value;
            if (!exerciseId) { document.getElementById('exerciseContainer').classList.remove('active'); return; }
            try {
                const base = getBase();
                const response = await fetch(base + 'exercises/' + exerciseId + '.json');
                const exercise = await response.json();
                currentExerciseId = exerciseId;
                currentExercise = exercise;
                document.getElementById('questionText').textContent = exercise.question || 'No question provided.';
                const materialsList = document.getElementById('materialsList');
                materialsList.innerHTML = '';
                if (exercise.materials && exercise.materials.length > 0) {
                    exercise.materials.forEach(m => {
                        const li = document.createElement('li');
                        if (m.type === 'link') {
                            const a = document.createElement('a');
                            a.href = m.content;
                            a.target = '_blank';
                            a.textContent = m.title || m.content;
                            li.appendChild(a);
                        } else li.textContent = m.content;
                        materialsList.appendChild(li);
                    });
                } else materialsList.innerHTML = '<li>No additional materials provided.</li>';
                setEditorContent('');
                document.getElementById('resultBox').classList.remove('show', 'passed', 'failed');
                document.getElementById('consoleOutput').textContent = 'Console output will appear here after you run your code.';
                document.getElementById('consoleOutput').className = 'console-output empty';
                document.getElementById('exerciseContainer').classList.add('active');
                setTimeout(initEditor, 50);
            } catch (err) { console.error(err); alert('Error loading exercise.'); }
        });

        async function submitAnswer() {
            if (!currentExerciseId || !currentExercise) { alert('Please select an exercise first.'); return; }
            const answer = getEditorContent().trim();
            if (!answer) { alert('Please provide an answer before submitting.'); return; }
            const backendUrl = (BACKEND_URL || '').trim().replace(/\/$/, '');
            if (!backendUrl) {
                alert('Grading is not configured. The site owner needs to set BACKEND_URL in the code and deploy the backend.');
                return;
            }
            saveAuth();
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            const resultBox = document.getElementById('resultBox');
            submitBtn.disabled = true;
            loading.classList.add('show');
            resultBox.classList.remove('show');
            const body = { answer: answer };
            const apiKey = (document.getElementById('apiKey').value || '').trim();
            const username = (document.getElementById('authUser').value || '').trim();
            const password = document.getElementById('authPass').value;
            if (apiKey) body.api_key = apiKey;
            else if (username && password) { body.username = username; body.password = password; }
            try {
                const response = await fetch(backendUrl + '/api/exercises/' + currentExerciseId + '/grade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const result = await response.json();
                if (response.status === 401) {
                    alert(result.error || 'Invalid username or password.');
                    return;
                }
                if (response.status === 503) {
                    alert(result.error || 'No API key configured on server.');
                    return;
                }
                if (result.success) {
                    const score = typeof result.score === 'number' ? result.score : 0;
                    const passed = (result.passed === true || result.passed === 'true') || score >= 70;
                    resultBox.classList.remove('passed', 'failed');
                    resultBox.classList.add('show', passed ? 'passed' : 'failed');
                    document.getElementById('resultTitle').textContent = passed ? '‚úÖ Congratulations! You Passed!' : '‚ùå Not Quite There Yet';
                    document.getElementById('score').textContent = 'Score: ' + score + '/100';
                    document.getElementById('feedback').innerHTML = '<strong>Feedback:</strong><br>' + (result.feedback || '').replace(/\n/g, '<br>');
                    document.getElementById('suggestions').innerHTML = result.suggestions ? '<h4>üí° Suggestions for Improvement:</h4>' + (result.suggestions + '').replace(/\n/g, '<br>') : '';
                } else {
                    alert(result.error || 'Grading failed.');
                }
            } catch (err) {
                console.error(err);
                alert('Grading failed: ' + (err.message || err) + '. Check Backend URL and CORS.');
            } finally {
                submitBtn.disabled = false;
                loading.classList.remove('show');
            }
        }

        loadExercises();
    </script>
</body>
</html>
