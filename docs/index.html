<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Tutor - Exercise Platform</title>
    <base href="./">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .content { padding: 30px; }
        .exercise-selector { margin-bottom: 30px; }
        .exercise-selector select { width: 100%; padding: 15px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; cursor: pointer; }
        .exercise-selector select:focus { outline: none; border-color: #667eea; }
        .exercise-section { display: none; }
        .exercise-section.active { display: block; }
        .question-box { background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 25px; border-left: 5px solid #667eea; }
        .question-box h2 { color: #333; margin-bottom: 15px; font-size: 1.5em; }
        .question-box p { color: #555; line-height: 1.6; font-size: 1.1em; margin-bottom: 8px; }
        .question-list { margin-top: 6px; padding-left: 20px; }
        .question-list li { margin-bottom: 6px; color: #555; line-height: 1.5; font-size: 1.02em; }
        .materials-box { background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 25px; }
        .materials-box h3 { color: #1976d2; margin-bottom: 15px; }
        .materials-box ul { list-style: none; padding-left: 0; }
        .materials-box li { padding: 10px; margin-bottom: 10px; background: white; border-radius: 5px; border-left: 3px solid #1976d2; }
        .materials-box a { color: #1976d2; text-decoration: none; font-weight: 500; }
        .materials-box a:hover { text-decoration: underline; }
        .answer-section { margin-bottom: 25px; }
        .answer-section label { display: block; font-weight: 600; margin-bottom: 10px; color: #333; font-size: 1.1em; }
        .answer-section .editor-wrap { width: 100%; min-height: 220px; border: 2px solid #e0e0e0; border-radius: 8px; overflow: hidden; }
        .answer-section .editor-wrap:focus-within { border-color: #667eea; }
        #codeEditor { width: 100%; min-height: 220px; font-size: 14px; }
        .console-output { margin-top: 15px; padding: 15px; background: #1e1e1e; color: #d4d4d4; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-break: break-all; min-height: 80px; max-height: 200px; overflow-y: auto; }
        .console-output.empty { color: #888; }
        .console-output .stderr { color: #f48771; }
        .button-group { display: flex; gap: 15px; margin-bottom: 25px; }
        button { padding: 15px 30px; font-size: 16px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        .btn-submit { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; flex: 1; }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-run { background: #2e7d32; color: white; }
        .btn-run:hover { background: #1b5e20; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(46, 125, 50, 0.4); }
        .btn-run:disabled, .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .result-box { display: none; padding: 25px; border-radius: 10px; margin-top: 25px; }
        .result-box.show { display: block; }
        .result-box.passed { background: #e8f5e9; border-left: 5px solid #4caf50; }
        .result-box.failed { background: #ffebee; border-left: 5px solid #f44336; }
        .result-box h3 { margin-bottom: 15px; font-size: 1.5em; }
        .result-box.passed h3 { color: #2e7d32; }
        .result-box.failed h3 { color: #c62828; }
        .score { font-size: 2em; font-weight: bold; margin: 15px 0; }
        .result-box.passed .score { color: #4caf50; }
        .result-box.failed .score { color: #f44336; }
        .feedback { margin-top: 15px; line-height: 1.6; color: #333; }
        .suggestions { margin-top: 15px; padding: 15px; background: white; border-radius: 5px; border-left: 3px solid #ff9800; }
        .suggestions h4 { color: #f57c00; margin-bottom: 10px; }
        .loading { display: none; text-align: center; padding: 20px; }
        .loading.show { display: block; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .model-row { margin-top: 8px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .model-row label { width: auto; font-weight: 600; }
        .model-row select { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; }
        .model-hint { font-size: 0.8em; color: #555; margin-top: 4px; }
        .model-used { margin-top: 8px; font-size: 0.9em; color: #555; }
        .import-row { margin-top: 10px; font-size: 0.9em; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .import-row input[type="file"] { font-size: 0.9em; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/mode-python.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/theme-chrome.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ext-language_tools.js" charset="utf-8"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        .auth-box { background: #f0f4ff; padding: 16px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #667eea; }
        .auth-box h3 { font-size: 1em; margin-bottom: 10px; color: #333; }
        .auth-box label { display: inline-block; width: 120px; font-weight: 600; }
        .auth-box input { padding: 8px 12px; margin: 4px 8px 4px 0; border-radius: 6px; border: 1px solid #ccc; width: 260px; }
        .auth-box input[type="password"] { width: 260px; }
        .auth-box .row { margin-bottom: 8px; }
        .auth-box .hint { font-size: 0.85em; color: #666; margin-top: 8px; }
        .auth-box a { color: #1976d2; margin-left: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêç Python Tutor</h1>
            <p>Learn Python Programming - Complete Exercises and Get AI Feedback (Groq)</p>
        </div>
        <div class="content">
            <div class="auth-box">
                <h3>üîë To get your answers graded, enter your own Groq API key:</h3>
                <div class="row">
                    <label>Your API key</label>
                    <input type="password" id="apiKey" placeholder="Paste your Groq API key (gsk_‚Ä¶)" autocomplete="off" />
                    <a href="https://console.groq.com/keys" target="_blank" rel="noopener">Get a free API key ‚Üí</a>
                </div>
                <div class="model-row">
                    <label for="modelSelect">AI model</label>
                    <select id="modelSelect">
                        <option value="llama-3.3-70b-versatile" selected>llama-3.3-70b-versatile (70B, strong default)</option>
                        <option value="openai/gpt-oss-20b">openai/gpt-oss-20b (20B, moderate)</option>
                        <option value="openai/gpt-oss-120b">openai/gpt-oss-120b (120B, strongest)</option>
                        <option value="llama-3.2-11b-vision-preview">llama-3.2-11b-vision-preview (11B, compact)</option>
                    </select>
                </div>
                <div class="model-hint">Default is a strong 70B model; switch to 20B/11B for cheaper tests or 120B for the strictest, smartest grading.</div>
                <div class="hint">Your key is stored only in this browser (session storage) and sent directly to the backend for grading.</div>
            </div>
            <div class="exercise-selector">
                <select id="exerciseSelect">
                    <option value="">Select an exercise...</option>
                </select>
                <div class="import-row">
                    <span><strong>Import exercise JSON:</strong></span>
                    <input type="file" id="exerciseImport" accept="application/json" />
                    <span>(added only in this browser session)</span>
                </div>
            </div>
            <div id="exerciseContainer" class="exercise-section">
                <div class="question-box">
                    <h2>Question</h2>
                    <p id="questionIntro"></p>
                    <ul id="questionList" class="question-list"></ul>
                </div>
                <div class="materials-box">
                    <h3>üìö Learning Materials</h3>
                    <ul id="materialsList"></ul>
                </div>
                <div class="answer-section">
                    <label>Your Answer:</label>
                    <div class="editor-wrap">
                        <div id="codeEditor"></div>
                    </div>
                    <div class="console-output empty" id="consoleOutput">Console output will appear here after you run your code.</div>
                </div>
                <div class="button-group">
                    <button type="button" class="btn-run" id="runBtn" onclick="runCode()">‚ñ∂ Run Code</button>
                    <button class="btn-submit" id="submitBtn" onclick="submitAnswer()">Submit Answer</button>
                </div>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px;">Grading your answer...</p>
                </div>
                <div class="result-box" id="resultBox">
                    <h3 id="resultTitle"></h3>
                    <div class="score" id="score"></div>
                    <div class="feedback" id="feedback"></div>
                    <div class="suggestions" id="suggestions"></div>
                    <div class="model-used" id="modelUsed"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let currentExerciseId = null;
        let currentExercise = null;
        let exercises = [];
        let codeEditor = null;
        let pyodideReady = null;
        let lastModelUsed = null;

        const STORAGE_KEY = 'python_tutor_api_key';
        const MODEL_STORAGE_KEY = 'python_tutor_model';
        function loadAuth() {
            try {
                const s = sessionStorage.getItem(STORAGE_KEY);
                if (s) {
                    const o = JSON.parse(s);
                    if (o.apiKey) document.getElementById('apiKey').value = o.apiKey;
                }
                const m = sessionStorage.getItem(MODEL_STORAGE_KEY);
                if (m) {
                    const sel = document.getElementById('modelSelect');
                    if (sel) sel.value = m;
                }
            } catch (e) {}
        }
        function saveAuth() {
            const o = {
                apiKey: document.getElementById('apiKey').value
            };
            sessionStorage.setItem(STORAGE_KEY, JSON.stringify(o));
        }
        document.addEventListener('DOMContentLoaded', loadAuth);
        ['apiKey'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', saveAuth);
        });
        const modelSelectEl = document.getElementById('modelSelect');
        if (modelSelectEl) {
            modelSelectEl.addEventListener('change', () => {
                sessionStorage.setItem(MODEL_STORAGE_KEY, modelSelectEl.value);
            });
        }

        function getSelectedModel() {
            const el = document.getElementById('modelSelect');
            // Fallback default: a strong 70B model
            return (el && el.value) ? el.value : 'llama-3.3-70b-versatile';
        }

        function setLastModelUsed(model) {
            lastModelUsed = model;
            const el = document.getElementById('modelUsed');
            if (!el) return;
            if (!model) {
                el.textContent = '';
                return;
            }
            el.textContent = 'Model used for this grading: ' + model;
        }

        function getBase() {
            const p = window.location.pathname;
            if (p.endsWith('/')) return p;
            if (p.endsWith('index.html')) return p.replace(/index\.html$/, '');
            return p.replace(/\/[^/]*$/, '/') || '/';
        }

        function renderQuestion(rawQuestion) {
            const introEl = document.getElementById('questionIntro');
            const listEl = document.getElementById('questionList');
            if (!introEl || !listEl) return;

            introEl.textContent = '';
            listEl.innerHTML = '';

            if (!rawQuestion) {
                introEl.textContent = 'No question provided.';
                return;
            }

            const lines = String(rawQuestion)
                .split('\n')
                .map(l => l.trim());
            const nonEmpty = lines.filter(l => l.length > 0);

            if (nonEmpty.length === 0) {
                introEl.textContent = 'No question provided.';
                return;
            }

            // First non-empty line becomes the intro sentence.
            introEl.textContent = nonEmpty[0];

            // Remaining lines: try to turn leading "1. ", "2. " etc. into bullets.
            const bulletRegex = /^\d+\.\s*(.*)$/;
            nonEmpty.slice(1).forEach(line => {
                const match = line.match(bulletRegex);
                const text = match ? match[1] : line;
                if (!text) return;
                const li = document.createElement('li');
                li.textContent = text;
                listEl.appendChild(li);
            });
        }

        function getEditorContent() { return codeEditor ? codeEditor.getValue() : ''; }
        function setEditorContent(value) { if (codeEditor) codeEditor.setValue(value || '', -1); }

        function initEditor() {
            const el = document.getElementById('codeEditor');
            if (!el || codeEditor) return;
            codeEditor = ace.edit('codeEditor');
            codeEditor.setTheme('ace/theme/chrome');
            codeEditor.session.setMode('ace/mode/python');
            codeEditor.setOptions({ fontSize: '14px', showPrintMargin: false, highlightActiveLine: true, enableBasicAutocompletion: true, enableSnippets: true, enableLiveAutocompletion: true, tabSize: 4, useSoftTabs: true });
            codeEditor.session.setValue('# Write your Python code here\n', -1);
        }

        async function getPyodide() {
            // Wrapper around the global loadPyodide() from the CDN script.
            // We must NOT call ourselves recursively, so we use window.loadPyodide.
            if (pyodideReady) return pyodideReady;
            pyodideReady = window.loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/' });
            return pyodideReady;
        }

        async function runCode() {
            const code = getEditorContent().trim();
            if (!code) { updateConsole('', 'No code to run.', false); return; }
            const runBtn = document.getElementById('runBtn');
            const outEl = document.getElementById('consoleOutput');
            runBtn.disabled = true;
            outEl.classList.remove('empty');
            outEl.textContent = 'Loading Python...';

            try {
                const pyodide = await getPyodide();
                outEl.textContent = 'Running...';

                let stdout = '';
                let stderr = '';

                // Pyodide 0.24: use batched callback, not write(), and return nothing.
                pyodide.setStdout({
                    batched(data) {
                        stdout += data;
                    },
                });
                pyodide.setStderr({
                    batched(data) {
                        stderr += data;
                    },
                });

                await pyodide.runPythonAsync(code);
                updateConsole(stdout, stderr, true);
            } catch (err) {
                const raw = err && err.message ? err.message : String(err);
                const msg = simplifyPyodideError(raw);
                updateConsole('', msg, false);
            } finally {
                runBtn.disabled = false;
            }
        }

        function updateConsole(stdout, stderr, success) {
            const el = document.getElementById('consoleOutput');
            el.classList.remove('empty');
            el.innerHTML = '';
            if (stdout) { const pre = document.createElement('pre'); pre.textContent = stdout; el.appendChild(pre); }
            if (stderr) { const pre = document.createElement('pre'); pre.className = 'stderr'; pre.textContent = stderr; el.appendChild(pre); }
            if (!stdout && !stderr) el.textContent = success ? '(no output)' : 'Error';
        }

        function simplifyPyodideError(raw) {
            if (!raw) return '';
            const lines = String(raw).split('\n');
            // Show only the part that refers to the user's code (from File "<exec>" onwards)
            let start = lines.findIndex(l => l.includes('File "<exec>"'));
            if (start === -1) {
                // Fallback: last 3 non-empty lines (usually the actual error + message)
                const nonEmpty = lines.filter(l => l.trim());
                return nonEmpty.slice(-3).join('\n');
            }
            return lines.slice(start).join('\n').trim();
        }

        async function loadExercises() {
            try {
                const base = getBase();
                const response = await fetch(base + 'exercises/manifest.json');
                exercises = await response.json();
                const select = document.getElementById('exerciseSelect');
                select.innerHTML = '<option value="">Select an exercise...</option>';
                exercises.forEach(ex => {
                    const opt = document.createElement('option');
                    opt.value = ex.id;
                    opt.textContent = ex.title;
                    select.appendChild(opt);
                });
            } catch (e) { console.error('Error loading exercises:', e); }
        }

        async function importExerciseFromFile(file) {
            if (!file) return;
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                const exerciseId = data.id;
                if (!exerciseId) {
                    alert('Imported JSON needs an "id" field.');
                    return;
                }
                // Add to in-memory list
                exercises.push({
                    id: exerciseId,
                    title: data.title || exerciseId,
                    description: data.description || ''
                });
                // Add to existing select
                const select = document.getElementById('exerciseSelect');
                const opt = document.createElement('option');
                opt.value = exerciseId;
                opt.textContent = data.title || exerciseId;
                select.appendChild(opt);
                // Store full exercise object in a local map via a lightweight cache on window
                window.__importedExercises = window.__importedExercises || {};
                window.__importedExercises[exerciseId] = data;
                // Auto-select the imported exercise
                select.value = exerciseId;
                select.dispatchEvent(new Event('change'));
            } catch (e) {
                console.error(e);
                alert('Failed to import exercise JSON: ' + (e.message || e));
            }
        }

        document.getElementById('exerciseSelect').addEventListener('change', async function(e) {
            const exerciseId = e.target.value;
            if (!exerciseId) { document.getElementById('exerciseContainer').classList.remove('active'); return; }
            try {
                let exercise;
                if (window.__importedExercises && window.__importedExercises[exerciseId]) {
                    exercise = window.__importedExercises[exerciseId];
                } else {
                    const base = getBase();
                    const response = await fetch(base + 'exercises/' + exerciseId + '.json');
                    exercise = await response.json();
                }
                currentExerciseId = exerciseId;
                currentExercise = exercise;
                renderQuestion(exercise.question || '');
                const materialsList = document.getElementById('materialsList');
                materialsList.innerHTML = '';
                if (exercise.materials && exercise.materials.length > 0) {
                    exercise.materials.forEach(m => {
                        const li = document.createElement('li');
                        if (m.type === 'link') {
                            const a = document.createElement('a');
                            a.href = m.content;
                            a.target = '_blank';
                            a.textContent = m.title || m.content;
                            li.appendChild(a);
                        } else li.textContent = m.content;
                        materialsList.appendChild(li);
                    });
                } else materialsList.innerHTML = '<li>No additional materials provided.</li>';
                setEditorContent('');
                document.getElementById('resultBox').classList.remove('show', 'passed', 'failed');
                document.getElementById('consoleOutput').textContent = 'Console output will appear here after you run your code.';
                document.getElementById('consoleOutput').className = 'console-output empty';
                document.getElementById('exerciseContainer').classList.add('active');
                setTimeout(initEditor, 50);
            } catch (err) { console.error(err); alert('Error loading exercise.'); }
        });

        const importInput = document.getElementById('exerciseImport');
        if (importInput) {
            importInput.addEventListener('change', (e) => {
                const file = e.target.files && e.target.files[0];
                importExerciseFromFile(file);
                // reset so the same file can be chosen again if needed
                e.target.value = '';
            });
        }

        async function submitAnswer() {
            if (!currentExerciseId || !currentExercise) { alert('Please select an exercise first.'); return; }
            const answer = getEditorContent().trim();
            if (!answer) { alert('Please provide an answer before submitting.'); return; }
            saveAuth();
            const submitBtn = document.getElementById('submitBtn');
            const loading = document.getElementById('loading');
            const resultBox = document.getElementById('resultBox');
            submitBtn.disabled = true;
            loading.classList.add('show');
            resultBox.classList.remove('show');
            const apiKey = (document.getElementById('apiKey').value || '').trim();
            if (!apiKey) {
                alert('Please paste your Groq API key before submitting.');
                submitBtn.disabled = false;
                loading.classList.remove('show');
                return;
            }

            // Build grading prompt (client-side) using the same structure as the original backend.
            const question = currentExercise.question || '';
            const gradingInstructions = currentExercise.grading_instructions || currentExercise.gradingInstructions || '';
            const prompt =
`You are a Python programming tutor grading a student's answer. Grade based ONLY on the code below. Apply general programming semantics to ANY exercise.

STUDENT'S CODE:
---
${answer}
---

EXERCISE QUESTION:
${question}

GRADING INSTRUCTIONS:
${gradingInstructions}

---
UNIVERSAL PRINCIPLE (apply to every exercise):
When a requirement says to "print" or "use" variables with "descriptive labels", two things must be true:
(1) The variable NAME must appear in the print (e.g. {name}, {age}, {height}) ‚Äî not a literal like "Merlin" or 16.
(2) "Descriptive label" means ANY surrounding text that gives context ‚Äî e.g. "My name is", "I am", "years old", "stand", "m tall". The student does NOT need one specific phrase. All of these COUNT as descriptive and MET: print(f"My name is {name},"), print(f"I am {age} years old"), print(f"and I stand {height}m tall.").

DO NOT claim "age" or "height" are "missing descriptive labels" when the code has print(f"I am {age} years old") or print(f"and I stand {height}m tall."). That is FALSE ‚Äî those lines clearly have descriptive text. Only mark NOT MET when the variable is missing (literal used instead) or there is no context at all (e.g. just print(age)).
---

BEFORE GRADING:
1. List which variables the exercise asks to create/use.
2. For each, check: is that variable name actually used later (e.g. in print, in expressions), or did the student write literal values instead? If literals are used where the variable should be, mark that requirement NOT MET.
3. Only then assign score and write feedback.

RULES:
- If variables are defined but output uses literals instead of those variables (e.g. print(f"My name is Merlin") instead of {name}), the requirement is NOT met. Score below 70.
- If the code uses the variables ({name}, {age}, {height}) in print with ANY descriptive text (e.g. "I am {age} years old", "stand {height}m tall"), that requirement IS MET. Do NOT say it is missing or "not fully met".
- Do NOT invent missing requirements. Do NOT say "age and height are missing descriptive labels" when the code has print(f"I am {age} years old") and print(f"and I stand {height}m tall") ‚Äî that is incorrect. Only mark missing what is actually wrong.
- Do not suggest adding something that is already there.

SCORING (apply strictly ‚Äî do not be lenient):
- PERFECT (all requirements fully met, no issues): Give 95‚Äì100. Prefer 100 for clearly perfect code. Do NOT cap at 90.
- ANY requirement missing or wrong: Score MUST be at most 65. Never give 70 or above when a requirement is not met. passed MUST be false.
- One critical requirement missing (e.g. not using variables in output): 45‚Äì65 max.
- Two or more requirements missing: 20‚Äì40 max.
- Syntax errors: 0‚Äì20.
So: missing requirement ‚áí score ‚â§ 65 ‚áí FAIL. Perfect code ‚áí score 95‚Äì100.

FEEDBACK: Friendly, specific. For critical mistakes (e.g. literals instead of variables), say clearly that this is why they did not pass and what to fix.

SUGGESTIONS: Only for what is actually missing. Empty string if all met.

Respond with ONLY a valid JSON object:
{"score": <number>, "passed": <true ONLY if score >= 70 AND all requirements met ‚Äî if any requirement missing, passed MUST be false and score ‚â§ 65>, "feedback": "<personalized feedback>", "suggestions": "<only what is actually missing or empty string>"}`;

            try {
                const modelToUse = getSelectedModel();
                setLastModelUsed(modelToUse);
                const groqResponse = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        model: modelToUse,
                        temperature: 0.4,
                        messages: [
                            {
                                role: 'system',
                                content: "You are a Python tutor who grades code accurately. You apply general programming semantics: e.g. if a task asks to 'print the variables', you check that the code actually uses those variable names in the print (e.g. {name}) ‚Äî not hardcoded literal values. You are friendly and specific. You only mark requirements missing when they are actually missing. Always respond with valid JSON only."
                            },
                            { role: 'user', content: prompt }
                        ]
                    })
                });

                if (!groqResponse.ok) {
                    const text = await groqResponse.text();
                    throw new Error('Groq API error: ' + groqResponse.status + ' ' + text);
                }

                const groqData = await groqResponse.json();
                const choices = groqData.choices || [];
                const content = (choices[0] && choices[0].message && choices[0].message.content) ? choices[0].message.content.trim() : '';

                let result;
                if (content) {
                    const start = content.indexOf('{');
                    const end = content.lastIndexOf('}') + 1;
                    if (start >= 0 && end > start) {
                        result = JSON.parse(content.slice(start, end));
                    }
                }
                if (!result) {
                    result = { score: 0, passed: false, feedback: content || 'No feedback.', suggestions: '' };
                }

                const score = typeof result.score === 'number' ? result.score : 0;
                let passed = result.passed === true || result.passed === 'true' || score >= 70;
                if (score < 70) passed = false; // enforce fail < 70

                resultBox.classList.remove('passed', 'failed');
                resultBox.classList.add('show', passed ? 'passed' : 'failed');
                document.getElementById('resultTitle').textContent = passed ? '‚úÖ Congratulations! You Passed!' : '‚ùå Not Quite There Yet';
                document.getElementById('score').textContent = 'Score: ' + score + '/100';
                document.getElementById('feedback').innerHTML = '<strong>Feedback:</strong><br>' + (result.feedback || '').replace(/\n/g, '<br>');
                document.getElementById('suggestions').innerHTML = result.suggestions ? '<h4>üí° Suggestions for Improvement:</h4>' + (result.suggestions + '').replace(/\n/g, '<br>') : '';
            } catch (err) {
                console.error(err);
                alert('Grading failed: ' + (err.message || err));
            } finally {
                submitBtn.disabled = false;
                loading.classList.remove('show');
            }
        }

        loadExercises();
    </script>
</body>
</html>
